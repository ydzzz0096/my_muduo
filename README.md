# MyMuduo - A High-Performance C++ Network Library

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Language](https://img.shields.io/badge/language-C%2B%2B11-orange.svg)](https://en.cppreference.com/)
[![Build Status](https://img.shields.io/badge/build-passing-brightgreen.svg)]()
[![Platform](https://img.shields.io/badge/platform-Linux%20%7C%20WSL2-lightgrey.svg)]()

> **æ ¸å¿ƒäº®ç‚¹**: åœ¨å•æœºç¯å¢ƒï¼ˆWSL2ï¼‰ä¸‹ï¼ŒEcho Ping-Pong å‹æµ‹ **QPS çªç ´ 120 ä¸‡**ï¼Œååé‡è¾¾ **40 MB/s**ã€‚

## ğŸ“– é¡¹ç›®ç®€ä»‹ (Introduction)

**MyMuduo** æ˜¯ä¸€ä¸ªåŸºäº **Reactor æ¨¡å‹** çš„é«˜æ€§èƒ½ C++11 ç½‘ç»œåº“ã€‚

æœ¬é¡¹ç›®æ˜¯é™ˆç¡•å…ˆç”Ÿ `muduo` ç½‘ç»œåº“çš„æ ¸å¿ƒé‡æ„ä¸å®ç°ã€‚æˆ‘æ‘’å¼ƒäº†åŸåº“ä¸­å¯¹ Boost åº“çš„ä¾èµ–ï¼Œå®Œå…¨ä½¿ç”¨ **ç°ä»£ C++ (C++11/14)** ç‰¹æ€§ï¼ˆå¦‚ `std::function`, `std::shared_ptr`, `std::thread` ç­‰ï¼‰è¿›è¡Œäº†é‡å†™ã€‚

è¯¥é¡¹ç›®æ—¨åœ¨æ·±å…¥æ¢ç´¢é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹çš„æ ¸å¿ƒåŸç†ï¼ŒåŒ…æ‹¬éé˜»å¡ I/Oã€äº‹ä»¶é©±åŠ¨å¾ªç¯ã€å¤šçº¿ç¨‹æ¨¡å‹ä»¥åŠé«˜å¹¶å‘åœºæ™¯ä¸‹çš„èµ„æºç®¡ç†ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€ä¸ªç©å…·é¡¹ç›®ï¼Œæ›´æ˜¯ä¸€ä¸ªå…·å¤‡**å·¥ä¸šçº§æ¶æ„**ã€æ”¯æŒ**é«˜å¹¶å‘**ã€**æ–­çº¿é‡è¿**å’Œ**å¼‚æ­¥æ—¥å¿—**çš„å®Œæ•´ç½‘ç»œè§£å†³æ–¹æ¡ˆã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§ (Key Features)

* **åº•å±‚æ¨¡å‹**: é‡‡ç”¨ **Epoll LT** (æ°´å¹³è§¦å‘) + **éé˜»å¡ I/O** (Non-blocking I/O)ï¼Œè¿™æ˜¯ç›®å‰ Linux ä¸‹æœ€æˆç†Ÿçš„é«˜å¹¶å‘å¤„ç†æ–¹æ¡ˆã€‚
* **çº¿ç¨‹æ¨¡å‹**: å®ç°äº† **Multi-Reactors** (ä¸»ä» Reactor) + **One Loop Per Thread** æ¨¡å‹ã€‚
    * **MainLoop**: ä¸»çº¿ç¨‹åªè´Ÿè´£ `accept` æ–°è¿æ¥ï¼Œå¤„ç†é«˜ä¼˜å…ˆçº§çš„è¿æ¥å»ºç«‹ã€‚
    * **SubLoops**: å›ºå®šæ•°é‡çš„ I/O å­çº¿ç¨‹æ± ï¼Œé€šè¿‡**è½®è¯¢ (Round-Robin)** ç­–ç•¥åˆ†æ‹…å·²è¿æ¥ Socket çš„è¯»å†™äº‹ä»¶ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUã€‚
* **å¹¶å‘ä¼˜åŒ–**:
    * åˆ©ç”¨ Linux ç‰¹æœ‰çš„ **`eventfd`** å®ç°é«˜æ•ˆçš„çº¿ç¨‹é—´å”¤é†’ä¸é€šä¿¡ï¼Œæ›¿ä»£äº†ä¼ ç»Ÿçš„ç®¡é“/Socketå¯¹ã€‚
    * å®ç°äº†åŸºäº**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹**çš„ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒè·¨çº¿ç¨‹ä»»åŠ¡æ´¾å‘ (`runInLoop`/`queueInLoop`)ï¼Œå°† I/O æ“ä½œä¸¥æ ¼é™åˆ¶åœ¨æ‰€å±çº¿ç¨‹å†…ï¼Œå®ç°äº†**æ— é”åŒ– (Lock-free)** çš„ I/O å¤„ç†è·¯å¾„ã€‚
* **å†…å­˜ä¸èµ„æºç®¡ç†**:
    * å…¨é¢éµå¾ª **RAII** (èµ„æºè·å–å³åˆå§‹åŒ–) åŸåˆ™ç®¡ç† Socketã€Thread ç­‰èµ„æºï¼Œæœç»å†…å­˜æ³„æ¼ã€‚
    * å·§å¦™åˆ©ç”¨ `std::shared_ptr` å’Œ `std::weak_ptr` (ç»“åˆ **`tie` æœºåˆ¶**)ï¼Œè§£å†³äº†å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¯¹è±¡ç”Ÿå‘½å‘¨æœŸæ¨¡ç³Šå¯¼è‡´çš„**ç«æ€æ¡ä»¶** (Race Condition) å’Œæ‚¬ç©ºæŒ‡é’ˆé—®é¢˜ã€‚
* **é«˜æ€§èƒ½ç»„ä»¶**:
    * **Buffer**: å®ç°äº†åº”ç”¨å±‚ç¼“å†²åŒºï¼Œåˆ©ç”¨ `readv` è¿›è¡Œåˆ†æ•£è¯» (Scatter Read)ï¼Œåœ¨æ ˆä¸Šåˆ†é…ä¸´æ—¶ç©ºé—´ï¼Œæœ€å¤§é™åº¦å‡å°‘ç³»ç»Ÿè°ƒç”¨ (`read`) æ¬¡æ•°ã€‚
    * **AsyncLogging**: å®ç°äº†**åŒç¼“å†²åŒº** (Double Buffering) æŠ€æœ¯çš„å‰ç«¯/åç«¯åˆ†ç¦»å¼‚æ­¥æ—¥å¿—ï¼Œå°†ç£ç›˜ I/O ä»ä¸šåŠ¡çº¿ç¨‹ä¸­å‰¥ç¦»ï¼Œç¡®ä¿ä¸šåŠ¡å¤„ç†çš„ä½å»¶è¿Ÿã€‚
    * **TimerQueue**: åŸºäº `timerfd` å’Œ `std::set` å®ç°äº†é«˜ç²¾åº¦çš„å®šæ—¶å™¨é˜Ÿåˆ—ï¼Œæ”¯æŒä¸€æ¬¡æ€§å’Œå‘¨æœŸæ€§ä»»åŠ¡ã€‚

## ğŸ“Š æ€§èƒ½æµ‹è¯• (Benchmark)

æœ¬é¡¹ç›®ç»è¿‡äº†ä¸¥è‹›çš„å‹åŠ›æµ‹è¯•ã€‚ä½¿ç”¨ Ping-Pong æ¨¡å¼ï¼ˆå®¢æˆ·ç«¯å‘é€æ•°æ® -> æœåŠ¡å™¨å›æ˜¾ -> å®¢æˆ·ç«¯æ”¶åˆ°ç«‹åˆ»å†æ¬¡å‘é€ï¼‰éªŒè¯ååé‡ä¸å¹¶å‘èƒ½åŠ›ã€‚

### æµ‹è¯•ç¯å¢ƒ
* **OS**: Ubuntu 22.04 (WSL2 on Windows 11)
* **CPU**: Intel Core i9-13900H (14 Cores, 20 Threads)
* **Compiler**: g++ 11.4.0 (Optimization: -O3)
* **Memory**: 8GB (WSL limit)

### æµ‹è¯•ç»“æœ
åœ¨å¼€å¯ **8 ä¸ªå¹¶å‘å®¢æˆ·ç«¯è¿›ç¨‹**ï¼ˆæ¨¡æ‹Ÿ 1000+ å¹¶å‘è¿æ¥ï¼‰ï¼Œæ¯ä¸ªè¿›ç¨‹ç–¯ç‹‚å‘é€ 36 bytes æ¶ˆæ¯çš„åœºæ™¯ä¸‹ï¼ŒæœåŠ¡å™¨è¡¨ç°å¦‚ä¸‹ï¼š

| Metric | Result |
| :--- | :--- |
| **Total QPS** | **1,200,000+** |
| **Throughput** | **40 MiB/s+** |

> **å‹æµ‹æˆªå›¾**:
>
> ![Benchmark Screenshot](doc/images/benchmark.png)
> *ï¼ˆå›¾ï¼š8è¿›ç¨‹å¹¶å‘å‹æµ‹ï¼Œå•æœº QPS çªç ´ 120 ä¸‡ï¼‰*

**(æ³¨ï¼šæµ‹è¯•ç¦ç”¨äº†æ—¥å¿—è¾“å‡ºä»¥æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒæ€§èƒ½)**
### ğŸ“‰ å¹¶å‘ä¸èµ„æºæ¶ˆè€— (Concurrency & Resources)

é™¤äº†é«˜ååé‡ï¼Œæœ¬é¡¹ç›®è¿˜ç»è¿‡äº† C10K/C20K (2ä¸‡å¹¶å‘) ç¨³å®šæ€§æµ‹è¯•ï¼ŒéªŒè¯äº†åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æä½çš„èµ„æºå ç”¨ã€‚

**æµ‹è¯•ç¯å¢ƒ**:
* Client: Python è„šæœ¬æ¨¡æ‹Ÿ 20,000 ä¸ªç©ºé—² TCP è¿æ¥ã€‚
* Server: WSL2 (Ubuntu 22.04), Limit `ulimit -n 65535`ã€‚

**æµ‹è¯•ç»“æœ**:
* **å¹¶å‘è¿æ¥æ•°**: æˆåŠŸç»´æŒ **20,000+** ä¸ªåŒæ—¶åœ¨çº¿è¿æ¥ã€‚
* **å†…å­˜å ç”¨**:
    * åˆå§‹ RSS: ~3.6 MB
    * 20k è¿æ¥å RSS: ~33.3 MB
    * **å¹³å‡æ¯è¿æ¥æ¶ˆè€—**: **~1.5 KB** (åº”ç”¨å±‚å†…å­˜)

> **æ•°æ®è¯æ®**:
>
> 1. **è¿æ¥æ•°éªŒè¯** (`ss -s` æ˜¾ç¤º 20k+ established):
> ![Connections](doc/images/benchmark_c10k_connections.png)
>
> 2. **å†…å­˜æ¶ˆè€—ç›‘æ§** (RSS ä» 3680KB æ¶¨è‡³ 34080KB):
> ![Memory Usage](doc/images/benchmark_c10k_memory.png)


## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„ (Architecture)

MyMuduo é‡‡ç”¨å…¸å‹çš„ **ä¸»ä» Reactor å¤šçº¿ç¨‹æ¶æ„**ï¼š

1.  **TcpServer** ä½œä¸ºå¤–è§‚ (Facade)ï¼Œç®¡ç† `Acceptor` å’Œ `EventLoopThreadPool`ã€‚
2.  **Acceptor** è¿è¡Œåœ¨ `MainLoop` ä¸­ï¼Œä¸“é—¨ç›‘å¬æ–°è¿æ¥ã€‚
3.  æ–°è¿æ¥å»ºç«‹åï¼Œå°è£…ä¸º **TcpConnection**ï¼Œå¹¶é€šè¿‡è½®è¯¢ç®—æ³•æ´¾å‘ç»™æŸä¸ª **SubLoop** (I/O çº¿ç¨‹)ã€‚
4.  **TcpConnection** åœ¨å…¶æ‰€å±çš„ `SubLoop` ä¸­å¤„ç†æ‰€æœ‰è¯»å†™äº‹ä»¶ï¼Œåˆ©ç”¨ **Channel** å’Œ **Poller** ä¸ `epoll` å†…æ ¸äº¤äº’ã€‚


## ğŸ› ï¸ æ„å»ºä¸è¿è¡Œ (Build & Run)

### ç¯å¢ƒè¦æ±‚
* Linux Kernel version >= 2.6.28 (æ”¯æŒ `timerfd`, `eventfd`)
* CMake >= 3.0
* GCC >= 4.8 (æ”¯æŒ C++11)

### ç¼–è¯‘æ­¥éª¤

```bash
# 1. å…‹éš†ä»“åº“
git clone https://github.com/ydzzz0096/my_muduo.git
cd my_muduo

# 2. åˆ›å»ºæ„å»ºç›®å½•
mkdir build && cd build

# 3. ç¼–è¯‘ (æ¨èä½¿ç”¨ Release æ¨¡å¼ä»¥è·å¾—æœ€ä½³æ€§èƒ½)
cmake -DCMAKE_BUILD_TYPE=Release ..
make -j4